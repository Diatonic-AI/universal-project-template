# CI Workflow - Continuous Integration
#
# Purpose: Run automated quality checks on every push and pull request
# Triggers: All branches (push), all pull requests
# Duration: ~2-5 minutes
#
# What it does:
# 1. Auto-detects project language (Node.js, Python, or both)
# 2. Runs linters (Markdown, Shell scripts, GitHub Actions)
# 3. Runs tests if present
# 4. Enforces code quality standards
#
# Customization:
# - Add your language-specific linters/tests in the respective sections
# - See docs/CI-CD-PIPELINE.md for examples (Go, Rust, Docker, etc.)
# - Update branch protection to require this check before merging
#
name: CI

on:
  push:
    # Trigger on pushes to any branch
    # To limit to specific branches: branches: [main, develop]
  pull_request:
    # Trigger on all pull requests
    # To limit: branches: [main, develop]

# Cancel previous runs of this workflow when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent hanging jobs

    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js (conditional)
      # Only runs if package.json exists (auto-detection)
      - name: Setup Node.js
        if: ${{ hashFiles('**/package.json') != '' }}
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          # cache: 'npm'  # Uncomment to enable npm caching for faster builds

      # Step 3: Setup Python (conditional)
      # Only runs if Python project files exist (auto-detection)
      - name: Setup Python
        if: ${{ hashFiles('**/pyproject.toml','**/requirements.txt') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          # cache: 'pip'  # Uncomment to enable pip caching

      # Step 4: Install linters
      # These linters work for any project type (language-agnostic)
      - name: Install linters
        run: |
          # Install markdown and general formatting linters
          npm i -g markdownlint-cli2 prettier || true

          # Download actionlint for GitHub Actions validation
          echo "Downloading actionlint..."
          mkdir -p ./bin
          curl -sSf https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash | bash -s -- latest ./bin
          echo "$PWD/bin" >> $GITHUB_PATH

      # Step 5: Lint Markdown files
      # Checks all .md files for formatting issues
      # Non-blocking (|| true) to allow template customization
      - name: "Lint: Markdown"
        run: markdownlint-cli2 "**/*.md" "#node_modules" "#.git" || true

      # Step 6: Lint Shell scripts
      # Checks all .sh files for common issues
      # Non-blocking to allow template customization
      - name: "Lint: Shell scripts"
        run: shellcheck -x $(git ls-files '*.sh') || true

      # Step 7: Lint GitHub Actions workflows
      # Validates .github/workflows/*.yml files
      # Non-blocking to allow template customization
      - name: "Lint: GitHub Actions"
        run: actionlint || true

      # Step 8: Node.js tests (conditional)
      # Only runs if package.json exists
      # Customize: Add 'npm run lint' or 'npm run build' here
      - name: Run Node.js tests
        if: ${{ hashFiles('**/package.json') != '' }}
        run: |
          npm ci  # Install dependencies from lockfile
          npm test --if-present  # Run tests if "test" script exists

          # Add custom steps for your project:
          # npm run lint
          # npm run type-check
          # npm run build

      # Step 9: Python tests (conditional)
      # Only runs if Python project files exist
      # Customize: Add 'ruff check' or other linters here
      - name: Run Python tests
        if: ${{ hashFiles('**/pyproject.toml','**/requirements.txt') != '' }}
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if command -v pytest >/dev/null 2>&1; then pytest -q || true; fi

          # Add custom steps for your project:
          # ruff check .
          # black --check .
          # mypy .
